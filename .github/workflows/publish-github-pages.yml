# Copyright (c) 2021, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.
#
# Description
#  Use Hugo to build static site and publish to gh-pages
#
name: "PublishGitHubPages"

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '15 3 * * 1'

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true

    steps:
      - name: Checkout main
        uses: actions/checkout@v2.3.4
        with:
          ref: main
          fetch-depth: 32
          path: main

      - name: Verify changes to documentation present
        uses: actions/checkout@v2.3.4
        run: |
          cd main
          X=`git diff HEAD~1 --name-only | grep "^documentation" | wc -l`
          if [ $X == "0" ]; then
            echo 'No changes to the docs, exiting...'
            exit 1
          fi

      - name: Build site
        run: |
          curl -fL -o hugo.tar.gz "https://github.com/gohugoio/hugo/releases/download/v0.82.0/hugo_0.82.0_Linux-64bit.tar.gz"
          tar -xf hugo.tar.gz
          rm -rf /tmp/WORK
          mkdir -p $/tmp/WORK
          cd main/code/documentation
          ./publish.sh -o /tmp/WORK

      - name: Checkout and publish to gh-pages
        uses: actions/checkout@v2.3.4
        with:
          ref: gh-pages
          path: gh-pages
        run: |
          cd gh-pages
          rm -Rf *
          cp -R /tmp/WORK/* .
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add --all
          git commit -m "Documentation update"
          git push origin gh-pages
